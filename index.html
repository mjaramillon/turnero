<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Diagnóstico Turnero - Comfamiliar</title>
  
  <script src="https://www.gstatic.com/cv/js/sender/v3/cast_sender.js?loadCastFramework=1"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; background: #2c3e50; color: white; text-align: center; }
    #log { background: #000; color: #0f0; padding: 15px; text-align: left; font-family: monospace; height: 300px; overflow-y: auto; border-radius: 10px; margin-top: 20px; }
    .btn { padding: 15px 30px; font-size: 1.2rem; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; display: none; }
    .success { color: #0f0; font-weight: bold; }
    .error { color: #ff4d4d; }
  </style>
</head>
<body>

  <h2>DIAGNÓSTICO DE CONEXIÓN CHROMECAST</h2>
  <p id="status">Estado: Verificando componentes...</p>
  
  <button id="btn-transmitir" class="btn" onclick="conectar()">CONECTAR AHORA</button>

  <div id="log">Iniciando traza de errores...</div>

  <script>
    function escribirLog(msg, color) {
      var log = document.getElementById('log');
      var span = document.createElement('div');
      if(color) span.className = color;
      span.innerHTML = "> " + msg;
      log.appendChild(span);
      log.scrollTop = log.scrollHeight;
    }

    // 1. EL MÉTODO OFICIAL
    window.__onGCastApiAvailable = function(isAvailable) {
      if (isAvailable) {
        escribirLog("Google ha respondido: ¡El SDK está disponible!", "success");
        inicializar();
      } else {
        escribirLog("Google ha respondido: SDK NO disponible en este navegador.", "error");
      }
    };

    // 2. EL MÉTODO DE FUERZA BRUTA (Por si el anterior no se dispara)
    var intentos = 0;
    var monitor = setInterval(function() {
      intentos++;
      escribirLog("Intento " + intentos + ": Verificando objetos en memoria...");
      
      var hasCast = !!window.cast;
      var hasFramework = hasCast && !!window.cast.framework;
      var hasChromeCast = !!window.chrome && !!window.chrome.cast;

      escribirLog("Cast: " + hasCast + " | Framework: " + hasFramework + " | ChromeCast API: " + hasChromeCast);

      if (hasFramework && hasChromeCast) {
        escribirLog("¡Todos los componentes encontrados manualmente!", "success");
        clearInterval(monitor);
        inicializar();
      }

      if (intentos > 15) {
        escribirLog("ERROR CRÍTICO: El SDK no carga. Posible bloqueo de extensión o navegador no compatible.", "error");
        clearInterval(monitor);
      }
    }, 2000);

    function inicializar() {
      try {
        var context = cast.framework.CastContext.getInstance();
        context.setOptions({
          receiverApplicationId: 'B01CDD80',
          autoJoinPolicy: 'origin_scoped'
        });
        
        document.getElementById('status').innerText = "¡SISTEMA LISTO!";
        document.getElementById('btn-transmitir').style.display = "inline-block";
        escribirLog("Esperando que hagas clic en CONECTAR.", "success");
      } catch(e) {
        escribirLog("Fallo al configurar el contexto: " + e.message, "error");
      }
    }

    function conectar() {
      escribirLog("Abriendo selector de dispositivos...");
      cast.framework.CastContext.getInstance().requestSession().then(
        function() { escribirLog("Conexión establecida con éxito.", "success"); },
        function(err) { escribirLog("Error de conexión: " + err, "error"); }
      );
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Turnero Comfamiliar - Fix Registro</title>
  
  <script>
    // 1. VARIABLE GLOBAL PARA EVITAR RE-REGISTRO
    window.__onGCastApiAvailable = function(isAvailable) {
      if (isAvailable) {
        console.log("[Turnero] Google Cast API disponible nativamente.");
        inicializarCast();
      }
    };
  </script>

  <script src="https://www.gstatic.com/cv/js/sender/v3/cast_sender.js"></script>

  <style>
    :root { --primary: #004a99; --accent: #e67e22; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f4f4; }
    
    #btn-cast {
      position: absolute; top: 20px; right: 20px; z-index: 1001;
      background: white; padding: 12px 25px; border-radius: 50px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; 
      cursor: pointer; border: 2px solid #ddd; visibility: hidden;
    }
    .activo { visibility: visible !important; border-color: var(--primary) !important; }
    #btn-cast img { width: 25px; margin-right: 10px; }
  </style>
</head>
<body>

  <div id="btn-cast" onclick="lanzarMenu()">
    <img src="https://www.gstatic.com/images/icons/material/system/2x/cast_black_24dp.png">
    <span>CONECTAR A TV</span>
  </div>

  <div id="selector-sede" style="text-align:center; margin-top:100px;">
    <h1>SELECCIONAR SEDE</h1>
    <select id="lista-sedes" style="padding:10px; font-size:1.2rem;">
      <option value="Galicia">Sede Galicia</option>
      <option value="Circunvalar">Sede Circunvalar</option>
    </select>
    <button onclick="confirmarSede()" style="padding:10px 20px; background:var(--accent); color:white; border:none; cursor:pointer;">INICIAR</button>
  </div>

  <script>
    var APP_ID = "B01CDD80";
    var NAMESPACE = "urn:x-cast:com.comfamiliar.turnero";
    var sedeActual = "";

    // 3. MONITOR DE CARGA SEGURO
    var interval = setInterval(function() {
      if (window.chrome && window.chrome.cast && window.chrome.cast.isAvailable) {
        console.log("[Turnero] Hardware detectado. Inicializando...");
        inicializarCast();
        clearInterval(interval);
      }
    }, 1000);

    function inicializarCast() {
      // Usamos el framework nativo si ya fue registrado por el navegador
      cast.framework.CastContext.getInstance().setOptions({
        receiverApplicationId: APP_ID,
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
      });
      
      document.getElementById('btn-cast').classList.add('activo');
      console.log("[Turnero] Botón activado.");
    }

    function lanzarMenu() {
      cast.framework.CastContext.getInstance().requestSession().then(
        function() {
          var session = cast.framework.CastContext.getInstance().getCurrentSession();
          if (session) session.sendMessage(NAMESPACE, { sede: sedeActual });
        },
        function(err) { console.log("Error de conexión: " + err); }
      );
    }

    function confirmarSede() {
      sedeActual = document.getElementById('lista-sedes').value;
      document.getElementById('selector-sede').style.display = 'none';
      // Aquí iría tu lógica de cargarTurnos()...
    }
  </script>
</body>
</html>
